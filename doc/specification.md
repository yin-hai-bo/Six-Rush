# 「六子冲」游戏程序规格说明书

## 1. 项目概述

| 项目     | 说明                              |
| -------- | --------------------------------- |
| 项目名称 | 六子冲（人机对弈版）              |
| 开发语言 | Rust                              |
| 目标平台 | Windows（第一期），未来考虑跨平台 |
| 游戏类型 | 桌面GUI游戏，人机对弈棋类         |
| 游戏规则 | 参见 `rules.md`                 |

## 2. 功能规格

### 2.1 核心游戏流程

- 程序启动后，自动开启“由玩家执黑先行”的新局。
- 新局开始时
  - 若本局是电脑执黑先行，则进入“电脑思考中”状态；此时不接受玩家的任何输入，包括点击菜单、快捷按钮等。
  - 若本局是玩家执黑先行，则进入”等待玩家行棋“状态。此时玩家可点击己方棋子，或使用程序菜单、快捷按钮等UI控件。
- 在”等待玩家行棋“状态中，若玩家用鼠标点击己方棋子
  - 若该枚棋子可以移动（有通道），则进入“棋子已选中”状态，播放一个Click音效。该状态下：
    - 选中的棋子显示高亮效果（外圈光晕）
    - 所有合法目标点显示绿色提示标记
    - 用户不能操作菜单等UI控件
    - 只能点击鼠标左键选择目标点，或点击右键/非目标点取消选择
  - 在“棋子已选中”状态下点击左键：
    - 若点击的是合法目标点（绿色标记位置），则进入“棋子移动动画”状态，棋子以动画方式移动到目标点，播放落子音效
    - 若点击的是棋子原始位置或其他非目标点，取消选择，棋子保持原位，状态切回“等待玩家行棋”（不播放音效）
  - 在“棋子已选中”状态下点击右键：
    - 取消选择，棋子保持原位，状态切回“等待玩家行棋”
  - 若棋子产生了实际移动（目标点不同于起始点），则进入“判断吃子”状态
- 在“等待玩家行棋”状态中，玩家可操控UI控件。特别地，可以悔棋。
- “判断吃子”状态
  - 此状态下玩家不能操作UI控件。
  - 程序判断是否产生了吃子
    - 若产生了吃子，进入“吃子动画”状态
      - 此状态上不能操作UI控件。
      - 被吃的子闪烁几下，消失，并播放音效。
      - 动画完成后，进入到“胜负判断”状态。
- “胜负判断”状态
  - 不可操控UI。
  - 电脑判断当前是否出现了胜负，或平局。
    - 若电脑胜，弹框提示电脑胜利。框中提供一个“悔棋”按钮，允许玩家回退到前一次的“等待玩家行棋”状态。
    - 若人类胜，弹框提示人类胜利，棋局结束。
    - 若平局，弹框提示平局。框中提供“悔棋”按钮。
    - 在对话框中，玩家选择“确定棋局结束”，则本局结束，自动开启新局，新局的先行方与刚刚结束的这一局相同。
- 若被吃掉的子是电脑方，则切入到“电脑思考中”状态，否则切入到“等待玩家行棋”状态。
  - 若未产生吃子，若最近这一次的行棋方是人类，则切入到“电脑思考中”状态，否则切入到“等待玩家行棋”状态。
- “电脑思考中”状态里
  - 玩家不可操作任何UI控件，也不能点击任何棋子。
  - 电脑选出行棋落点后，进入“棋子移动动画”状态，电脑棋子以动画的方式移动到目标位置后，播放落子音效，然后进入到“判断吃子”状态
  - “电脑思考中”状态至少维持100ms，哪怕电脑已经提前想出方案，也要空等。
- 在“等待玩家行棋”状态，或电脑胜利/平局时的对话框弱出状态，玩家可以选择悔棋。
  - 点击悔棋后进行“悔棋动画中”状态
  - 此状态中，玩家法操作UI控件。
  - 此状态中，若有被吃掉的子，则这些棋子以渐显的方式淡入在它被吃掉的位置上重新出现。同时：
    - 若最近行棋的是电脑方，则电脑方的棋子以动画方式回退到行棋前的位置，回退完成后，人类玩家最近一次移动的棋子也以动画方式回退到原来的位置，回退完成后，切入到“等待玩家行棋”状态。
    - 若最近行棋的是人类，则人类玩家这一方的棋子以动画方式回退到行棋前的位置，回退完成后，切入到“等待玩家行棋”状态。

### 2.2 玩家交互规格

#### 2.2.1 行棋操作

轮到玩家行棋时

| 操作               | 说明                                                      | 反馈                                                         |
| ------------------ | --------------------------------------------------------- | ------------------------------------------------------------ |
| **点击棋子** | 鼠标左键点击己方可移动的棋子                              | 播放点击音效，棋子显示高亮，合法目标点显示绿色标记           |
| **选择目标** | 在“棋子已选中”状态下，左键点击绿色标记的合法目标点        | 棋子以动画方式从原位移动到目标点，播放落子音效               |
| **取消选择** | 在“棋子已选中”状态下，右键点击或点击非目标点              | 取消选中状态，返回“等待玩家行棋”，无音效                     |
| **容错范围** | 落点判断允许棋子半径的40%作为容错范围                     | 程序自动吸附到最近的合法交叉点                               |

#### 2.2.2 动画速度规格

- 所有动画使用缓动函数实现平滑效果。

| 动画类型     | 缓动函数        | 时长   | 说明                                              |
| ------------ | --------------- | ------ | ------------------------------------------------- |
| 棋子移动动画 | ease_in_out_quad | 300ms | 二次方缓入缓出，平滑开始和结束                    |
| 悔棋动画     | ease_out_quad    | 400ms | 二次方缓出，快速开始缓慢结束                      |
| 吃子闪烁     | -                | 600ms | 闪烁3次（每次200ms）                              |
| 吃子移除     | -                | 400ms | 棋子缩小并淡出                                    |

### 2.3 吃子动画规格

| 阶段               | 动画效果                                       | 时长      |
| ------------------ | ---------------------------------------------- | --------- |
| **闪烁提示** | 被吃棋子闪烁3次（透明度变化或缩放）            | 约600ms   |
| **移除动画** | 棋子缩小并淡出，同时向棋盘外（下方或侧边）移动 | 400-600ms |
| **音效**     | 吃子/担子音效在闪烁开始时播放                  | -         |

### 2.4 胜负与平局判定

| 触发时机           | 每次棋子数量发生变化后                            |
| ------------------ | ------------------------------------------------- |
| **判定内容** | 按 `rules.md` 规则判定困毙、无子、平局条件      |
| **胜负提示** | 弹窗显示"您赢了！"/"电脑获胜！"，同时播放相应音效 |
| **平局提示** | 弹窗显示"平局！"                                  |
| **后续操作** | 提供"悔棋"、"开始新局"、"退出"按钮                |

### 2.5 悔棋功能规格

| 项目                 | 说明                                                       |
| -------------------- | ---------------------------------------------------------- |
| **可悔棋状态** | 电脑行棋完成后的"等待玩家行棋"状态，且玩家至少已行棋过一次 |
| **悔棋操作**   | 点击菜单"悔棋"或使用快捷键（如 Ctrl+Z）                    |
| **悔棋范围**   | 回退最近一次电脑行棋，再回退最近一次玩家行棋               |
| **悔棋后状态** | 回到"等待玩家行棋"状态（即玩家重新走刚才那一步）           |
| **特殊情况**   | 胜负/平局结果弹出后，仍可悔棋                              |
| **不可悔棋**   | 游戏尚未开始、或已悔棋到棋局开始状态                       |
| **动画**       | 棋子以动画方式回到原位，被吃棋子恢复（闪烁后从棋盘外移回） |

### 2.6 音效系统规格

| 事件      | 音效类型           | 备注                 |
| --------- | ------------------ | -------------------- |
| 点击棋子  | 短促点击音         | 清脆，约100ms        |
| 拖拽中    | 无                 | -                    |
| 合法落子  | 落子音             | 木质或石质碰撞感     |
| 非法落子  | 错误提示音         | 低沉，区别于合法落子 |
| 吃子/担子 | 吃子音效           | 略长，有"吃掉"的感觉 |
| 电脑行棋  | 与玩家相同的落子音 | -                    |
| 玩家获胜  | 胜利音效           | 欢快                 |
| 电脑获胜  | 失败音效           | 低沉                 |
| 平局      | 中性音效           | -                    |

### 2.7 电脑AI规格

#### 2.7.1 棋力等级

| 等级    | 名称 | 算法策略                                         |
| ------- | ---- | ------------------------------------------------ |
| Level 1 | 新手 | 完全随机：从所有合法移动中均匀随机选择           |
| Level 2 | 初级 | 带基础评估的随机：优先选择能吃子的走法，否则随机 |
| Level 3 | 中级 | Minimax算法 + 简单评估函数（棋子数、位置等）     |
| Level 4 | 高级 | Minimax + Alpha-Beta剪枝 + 深度限制（如6层）     |
| Level 5 | 大师 | 完整搜索求解最优解（考虑游戏复杂度可控）         |

#### 2.7.2 AI行棋延迟

| 等级      | 思考延迟                       | 说明                 |
| --------- | ------------------------------ | -------------------- |
| Level 1-2 | 300-500ms                      | 模拟"思考"时间       |
| Level 3-4 | 实际计算时间 + 最小延迟(500ms) | 让玩家感受到"在思考" |
| Level 5   | 实际计算时间                   | 最快响应             |

#### 2.7.3 评估函数参考（Level 3+）

```rust
fn evaluate(&self, board: &Board, ai_side: Side) -> i32 {
    let player_side = ai_side.opposite();
    let ai_count = board.count_active(ai_side) as i32;
    let player_count = board.count_active(player_side) as i32;

    // 基础评估：棋子数差值 * 100
    let mut score = (ai_count - player_count) * 100;

    // 灵活性评估：可移动方向数
    let ai_moves = get_valid_moves(board, ai_side).len() as i32;
    let player_moves = get_valid_moves(board, player_side).len() as i32;
    score += (ai_moves - player_moves) * 5;

    // 困毙评估 - 这是最重要的
    if is_stalemated(board, player_side) {
        score += 10000;  // 玩家被困毙，AI大胜
    }
    if is_stalemated(board, ai_side) {
        score -= 10000;  // AI被困毙，AI大败
    }

    // 单子状态特殊评估
    if player_count == 1 && ai_count >= 2 {
        // 找到玩家的单子，计算其移动空间
        // 单子移动空间越小，对AI越有利
        score += (4 - empty_neighbors) * 50;
        // 鼓励AI棋子靠近单子（围堵）
        score += (6 - distance) * 10;
    }

    score
}
```

### 2.8 菜单系统规格

```
游戏(G)
├── 开始新局(F2)...    → 弹出对话框：选择"执黑先行"或"执白后行"
├── 加载游戏存档(F3)... → 打开文件对话框，加载.6zc存档
├── 保存当前棋局(F4)... → 保存当前棋局状态（.6zc格式）
├── ────────────────    （分隔线）
├── 悔棋(Ctrl+Z)       → 回退最近一次电脑行棋和玩家行棋
├── ────────────────    （分隔线）
└── 退出               → 退出程序

语言(L)
├── 简体中文           → 切换到中文界面
└── English            → 切换到英文界面

帮助(H)
├── 行棋规则           → 弹出窗口显示游戏规则
└── 关于               → 显示程序版本、版权信息
```

### 快捷工具栏

工具栏提供常用功能的快速访问按钮：
- 🎮 新局 - 开始新游戏
- 💾 保存 - 保存当前棋局（初始局面不可用）
- 📂 加载 - 加载存档
- ↩️ 悔棋 - 回退到玩家上一次行棋前
- 🌐 中文/EN - 切换语言
- 📖 规则 - 显示游戏规则
- ℹ️ 关于 - 显示关于信息

### 2.9 窗口规格

| 项目                 | 规格                                                    |
| -------------------- | ------------------------------------------------------- |
| **窗口类型**   | 标准窗口（跨平台）                                      |
| **尺寸**       | 固定大小 900×700 像素                                   |
| **最大化按钮** | 禁用（不可最大化）                                      |
| **最小化按钮** | 禁用（不可最小化）                                      |
| **关闭按钮**   | 可用                                                    |
| **标题栏**     | 显示"六子冲"或"SIX-RUSH"（根据语言设置）              |

### 字体支持

程序会自动尝试加载系统中的中文字体（按优先级）：
- Windows: 微软雅黑、宋体、黑体
- Linux: 文泉驿正黑、文泉驿微米黑、Noto Sans CJK
- macOS: 苹方、华文黑体、Arial Unicode

## 3. 技术规格

### 3.1 推荐技术栈

| 组件     | 推荐方案                   | 备选方案              |
| -------- | -------------------------- | --------------------- |
| GUI框架  | egui + eframe              | tauri + web前端, iced |
| 2D渲染   | 内置于egui                 | wgpu, piston          |
| 音频     | rodio                      | cpal                  |
| 资源管理 | 内嵌资源（include_bytes!） | 外部文件              |
| 序列化   | serde + serde_json         | 自定义二进制格式      |

### 3.2 核心模块设计

```
src/
├── main.rs              # 程序入口
├── lib.rs               # 库导出
├── game/
│   ├── mod.rs           # 游戏主逻辑与状态机驱动
│   ├── board.rs         # 棋盘定义与坐标转换
│   ├── piece.rs         # 棋子定义与初始布局
│   ├── rules.rs         # 行棋规则验证与吃子判定
│   ├── state.rs         # 游戏状态、事件与结果定义
│   ├── ai.rs            # AI算法实现（5个难度等级）
│   ├── audio.rs         # 音效系统（7种音效类型）
│   └── save.rs          # 存档/读档功能
├── ui/
│   ├── mod.rs           # UI模块入口
│   ├── app.rs           # 主应用状态与动画控制
│   ├── board_view.rs    # 棋盘渲染与交互
│   └── dialogs.rs       # 对话框（新局、游戏结束、规则、关于）
├── assets/
│   ├── images/          # 棋子、棋盘图片
│   └── sounds/          # 音效文件
└── utils/
    └── mod.rs           # 动画插值函数与辅助工具
```

### 3.3 数据结构要点

```rust
// 游戏状态（详见 state.rs）
pub enum GameState {
    NewGame,                    // 新局开始
    AiThinking,                 // 电脑思考中
    WaitingForPlayer,           // 等待玩家行棋
    PieceSelected,              // 棋子已选中
    PieceMoving,                // 棋子移动动画中
    CheckingCapture,            // 判断吃子
    CaptureAnimating,           // 吃子动画中
    CheckingGameEnd,            // 胜负判断
    GameOverDialog(GameResult), // 胜负平局弹框
    UndoAnimating,              // 悔棋动画中
}

// 棋子（详见 piece.rs）
pub struct Piece {
    pub id: u8,                    // 棋子唯一ID
    pub side: Side,                // Black / White
    pub position: (u8, u8),        // (x, y) 棋盘坐标
    pub state: PieceState,         // 当前状态
    pub active: bool,              // 是否仍在棋盘上
}

pub enum PieceState {
    Idle,           // 静止
    Dragging,       // 正在被拖拽（选中状态）
    Animating,      // 动画中
    BeingCaptured,  // 被吃掉的动画中
}

// 移动记录（用于悔棋，详见 mod.rs）
pub struct MoveRecord {
    pub piece_id: u8,              // 移动的棋子ID
    pub from: (u8, u8),            // 起始位置
    pub to: (u8, u8),              // 目标位置
    pub captured: Vec<CapturedRecord>, // 被吃掉的棋子记录
    pub was_single_piece_mode: bool,   // 是否进入了单子状态
    pub side: Side,                // 行棋方
}

pub struct CapturedRecord {
    pub piece_id: u8,              // 棋子ID
    pub position: (u8, u8),        // 被吃掉时的位置
}

// 游戏主结构（详见 mod.rs）
pub struct Game {
    pub board: Board,              // 当前棋盘状态
    pub state: GameState,          // 当前游戏状态
    pub player_side: Side,         // 玩家执子方
    pub current_turn: Side,        // 当前轮到哪方行棋
    pub move_history: Vec<MoveRecord>, // 行棋历史
    pub ai_level: u8,              // AI难度等级 (1-5)
    pub selected_piece: Option<SelectedPiece>, // 当前选中的棋子
    pub pending_move: Option<PendingMove>,     // 待执行的移动（动画用）
    pub last_captured: Vec<u8>,    // 最近一次被吃掉的棋子ID
    pub last_result: Option<GameResult>, // 游戏结果
}
```

### 3.4 坐标与渲染

| 项目                 | 说明                                                       |
| -------------------- | ---------------------------------------------------------- |
| **棋盘坐标系** | 采用 `rules.md` 定义的坐标系：(0,0) 左下角，(3,3) 右上角 |
| **渲染坐标**   | 屏幕像素坐标，Y轴向下（与多数GUI框架一致）                 |
| **坐标转换**   | 提供 `board_to_screen()` 和 `screen_to_board()` 函数   |
| **容错范围**   | 落点判断允许棋子半径的30%-50%作为容错范围                  |

## 4. 存档格式规格

存档文件采用JSON格式，扩展名 `.6zc`：

```json
{
  "version": 1,
  "board": [1, 1, 1, 1, 1, 0, 0, 1, 2, 0, 0, 2, 2, 2, 2, 2],
  "current_turn": "Black",
  "player_side": "Black"
}
```

### 格式说明

| 字段 | 类型 | 说明 |
|------|------|------|
| `version` | u8 | 存档版本号（当前为1） |
| `board` | [u8; 16] | 棋盘状态数组，索引 = y * 4 + x，值：0=空, 1=黑棋, 2=白棋 |
| `current_turn` | String | 当前轮到哪方行棋（"Black" 或 "White"） |
| `player_side` | String | 玩家执子方（"Black" 或 "White"） |

### 存档特性

- 加载后黑方先行，进入"等待玩家行棋"状态
- 不支持保存历史记录（加载后无法悔棋到存档前的状态）
- 文件扩展名为 `.6zc`（六子冲的拼音首字母）

## 5. 已实现功能

- [x] 跨平台支持（Windows/Linux/macOS）
- [x] 完整的音效系统（7种音效）
- [x] 存档/读档功能（.6zc格式）
- [x] 5级AI难度（从随机到完整搜索）
- [x] 悔棋功能（带动画）
- [x] 中英文双语支持
- [x] 吃子/担子动画
- [x] 棋子移动动画

## 6. 未来扩展

- [ ] 双人对弈模式（局域网或本地热座）
- [ ] 历史棋局回放
- [ ] AI难度自适应
- [ ] 主题换肤（棋盘、棋子样式）
- [ ] 操作统计与成就系统
- [ ] 棋盘翻转（让玩家始终处于下方）

## 7. 参考文档

- `rules.md` - 游戏规则详细说明
- `states.md` - 游戏状态流转图
- `tasks.md` - 开发任务清单
