# 「六子冲」游戏程序规格说明书

## 1. 项目概述

| 项目     | 说明                              |
| -------- | --------------------------------- |
| 项目名称 | 六子冲（人机对弈版）              |
| 开发语言 | Rust                              |
| 目标平台 | Windows（第一期），未来考虑跨平台 |
| 游戏类型 | 桌面GUI游戏，人机对弈棋类         |
| 游戏规则 | 参见 `rules.md`                 |

## 2. 功能规格

### 2.1 核心游戏流程

- 程序启动后，自动开启“由玩家执黑先行”的新局。
- 新局开始时
  - 若本局是电脑执黑先行，则进入“电脑思考中”状态；此时不接受玩家的任何输入，包括点击菜单、快捷按钮等。
  - 若本局是玩家执黑先行，则进入”等待玩家行棋“状态。此时玩家可点击己方棋子，或使用程序菜单、快捷按钮等UI控件。
- 在”等待玩家行棋“状态中，若玩家用鼠标点击己方棋子
  - 若该枚棋子可以移动（有通道），则进入“棋子吸附”状态，播放一个Click音效，棋子被吸附在鼠标光标上，随光标移动而移动（在最上层渲染）。棋子的移动不能超出棋盘范围。棋子被吸附到光标后，该棋子的原始位置上绘制一个标记来表示该棋子的原始位置。该状态下用户不能操作任何UI控件，只能点击鼠标左键或右键。
    - 点击左键表示在当前位置放下棋子。程序自动找到落点（允许一点误差），若落点合法（棋子的原始位置也是合法落点，表示让棋子放回原位），进入“棋子移动动画”状态，令棋子以一种动画的方式落到目标点。棋子落下时播放一个音效。
    - 在任意位置点击右键表示将棋子放回原始位置，等价于用左键将棋子放归原处。棋子落下时播放一个音效。
    - 棋子放归原处后，状态切回到“等待玩家行棋”状态。
    - 若棋子产生了移动，则进入“判断吃子”状态。
- 在“等待玩家行棋”状态中，玩家可操控UI控件。特别地，可以悔棋。
- “判断吃子”状态
  - 此状态下玩家不能操作UI控件。
  - 程序判断是否产生了吃子
    - 若产生了吃子，进入“吃子动画”状态
      - 此状态上不能操作UI控件。
      - 被吃的子闪烁几下，消失，并播放音效。
      - 动画完成后，进入到“胜负判断”状态。
- “胜负判断”状态
  - 不可操控UI。
  - 电脑判断当前是否出现了胜负，或平局。
    - 若电脑胜，弹框提示电脑胜利。框中提供一个“悔棋”按钮，允许玩家回退到前一次的“等待玩家行棋”状态。
    - 若人类胜，弹框提示人类胜利，棋局结束。
    - 若平局，弹框提示平局。框中提供“悔棋”按钮。
    - 在对话框中，玩家选择“确定棋局结束”，则本局结束，自动开启新局，新局的先行方与刚刚结束的这一局相同。
- 若被吃掉的子是电脑方，则切入到“电脑思考中”状态，否则切入到“等待玩家行棋”状态。
  - 若未产生吃子，若最近这一次的行棋方是人类，则切入到“电脑思考中”状态，否则切入到“等待玩家行棋”状态。
- “电脑思考中”状态里
  - 玩家不可操作任何UI控件，也不能点击任何棋子。
  - 电脑选出行棋落点后，进入“棋子移动动画”状态，电脑棋子以动画的方式移动到目标位置后，播放落子音效，然后进入到“判断吃子”状态
  - “电脑思考中”状态至少维持100ms，哪怕电脑已经提前想出方案，也要空等。
- 在“等待玩家行棋”状态，或电脑胜利/平局时的对话框弱出状态，玩家可以选择悔棋。
  - 点击悔棋后进行“悔棋动画中”状态
  - 此状态中，玩家法操作UI控件。
  - 此状态中，若有被吃掉的子，则这些棋子以渐显的方式淡入在它被吃掉的位置上重新出现。同时：
    - 若最近行棋的是电脑方，则电脑方的棋子以动画方式回退到行棋前的位置，回退完成后，人类玩家最近一次移动的棋子也以动画方式回退到原来的位置，回退完成后，切入到“等待玩家行棋”状态。
    - 若最近行棋的是人类，则人类玩家这一方的棋子以动画方式回退到行棋前的位置，回退完成后，切入到“等待玩家行棋”状态。

### 2.2 玩家交互规格

#### 2.2.1 行棋操作

轮到玩家行棋时

| 操作               | 说明                                                      | 反馈                                                         |
| ------------------ | --------------------------------------------------------- | ------------------------------------------------------------ |
| **点击棋子** | 鼠标左键点击己方棋子，为讨论方便，此时棋子的位置记为 O    | 播放点击音效，棋子轻微放大或高亮                             |
| **拖拽移动** | 移动鼠标，棋子位置随鼠标移动而变化，为讨论方便，位置记为R | 棋子跟随鼠标中心移动，保持在最上层渲染                       |
| **边界限制** | 棋子不可移出棋盘可视区域                                  | 棋子被限制在棋盘边界内跟随鼠标                               |
| **落子**     | 松开鼠标左键，为讨论方便，此时棋子/鼠标的位置记为E        | 程序计算落点棋盘坐标（允许±N像素的容错范围）                |
| **合法落子** | 目标位置为空且符合行棋规则，或目标位置就是棋子原始位置。  | 播放落子音效，棋子以动画方式从当前位置E（而不是O）移动到落点 |
| **非法落子** | 目标位置不合法                                            | 播放错误音效，棋子以动画方式从当前位置E回到原始位置O         |

#### 2.2.2 动画速度规格

- 所有动画中，涉及到棋子移动的，用可调节缓动曲线的运动速度，目前缓动方式暂定为匀加速。初速为0，加速度a=1000像素每秒。

| 动画类型     | 缓动方式        | 说明                                                                    |
| ------------ | --------------- | ----------------------------------------------------------------------- |
| 合法落子动画 | 匀加速          | 棋子初速为0，加速度a=1000像素每秒，匀加速移动到落点                     |
| 非法回弹动画 | 匀加速+落点弹跳 | 棋子以匀加速的方式回到原位，然后以三次微弹性效果结束，总时长维持在100ms |
| 电脑行棋动画 | 匀加速          | 电脑棋子从起点匀加速移动到终点，初速为0，加速度a=1000像素每秒           |

### 2.3 吃子动画规格

| 阶段               | 动画效果                                       | 时长      |
| ------------------ | ---------------------------------------------- | --------- |
| **闪烁提示** | 被吃棋子闪烁3次（透明度变化或缩放）            | 约600ms   |
| **移除动画** | 棋子缩小并淡出，同时向棋盘外（下方或侧边）移动 | 400-600ms |
| **音效**     | 吃子/担子音效在闪烁开始时播放                  | -         |

### 2.4 胜负与平局判定

| 触发时机           | 每次棋子数量发生变化后                            |
| ------------------ | ------------------------------------------------- |
| **判定内容** | 按 `rules.md` 规则判定困毙、无子、平局条件      |
| **胜负提示** | 弹窗显示"您赢了！"/"电脑获胜！"，同时播放相应音效 |
| **平局提示** | 弹窗显示"平局！"                                  |
| **后续操作** | 提供"悔棋"、"开始新局"、"退出"按钮                |

### 2.5 悔棋功能规格

| 项目                 | 说明                                                       |
| -------------------- | ---------------------------------------------------------- |
| **可悔棋状态** | 电脑行棋完成后的"等待玩家行棋"状态，且玩家至少已行棋过一次 |
| **悔棋操作**   | 点击菜单"悔棋"或使用快捷键（如 Ctrl+Z）                    |
| **悔棋范围**   | 回退最近一次电脑行棋，再回退最近一次玩家行棋               |
| **悔棋后状态** | 回到"等待玩家行棋"状态（即玩家重新走刚才那一步）           |
| **特殊情况**   | 胜负/平局结果弹出后，仍可悔棋                              |
| **不可悔棋**   | 游戏尚未开始、或已悔棋到棋局开始状态                       |
| **动画**       | 棋子以动画方式回到原位，被吃棋子恢复（闪烁后从棋盘外移回） |

### 2.6 音效系统规格

| 事件      | 音效类型           | 备注                 |
| --------- | ------------------ | -------------------- |
| 点击棋子  | 短促点击音         | 清脆，约100ms        |
| 拖拽中    | 无                 | -                    |
| 合法落子  | 落子音             | 木质或石质碰撞感     |
| 非法落子  | 错误提示音         | 低沉，区别于合法落子 |
| 吃子/担子 | 吃子音效           | 略长，有"吃掉"的感觉 |
| 电脑行棋  | 与玩家相同的落子音 | -                    |
| 玩家获胜  | 胜利音效           | 欢快                 |
| 电脑获胜  | 失败音效           | 低沉                 |
| 平局      | 中性音效           | -                    |

### 2.7 电脑AI规格

#### 2.7.1 棋力等级

| 等级    | 名称 | 算法策略                                         |
| ------- | ---- | ------------------------------------------------ |
| Level 1 | 新手 | 完全随机：从所有合法移动中均匀随机选择           |
| Level 2 | 初级 | 带基础评估的随机：优先选择能吃子的走法，否则随机 |
| Level 3 | 中级 | Minimax算法 + 简单评估函数（棋子数、位置等）     |
| Level 4 | 高级 | Minimax + Alpha-Beta剪枝 + 深度限制（如6层）     |
| Level 5 | 大师 | 完整搜索求解最优解（考虑游戏复杂度可控）         |

#### 2.7.2 AI行棋延迟

| 等级      | 思考延迟                       | 说明                 |
| --------- | ------------------------------ | -------------------- |
| Level 1-2 | 300-500ms                      | 模拟"思考"时间       |
| Level 3-4 | 实际计算时间 + 最小延迟(500ms) | 让玩家感受到"在思考" |
| Level 5   | 实际计算时间                   | 最快响应             |

#### 2.7.3 评估函数参考（Level 3+）

```
评估值 =
    己方棋子数 × 100
  - 对方棋子数 × 100
  + 己方棋子灵活性（可移动方向数）× 5
  + 己方棋子接近中心程度 × 2
  - 对方棋子灵活性 × 5
  + 吃子威胁值 × 20
```

### 2.8 菜单系统规格

```
游戏(&G)
├── 开始新局(&N)...    → 弹出对话框：选择"先行"或"后行"
├── 加载游戏存档(&L)... → 打开文件对话框，加载.sav或.json存档
├── 保存当前棋局(&S)... → 保存当前棋局状态（包括历史记录，支持悔棋）
├── ────────────────    （分隔线）
└── 退出               → 退出程序（若有进行中的棋局，提示确认）

帮助(&H)
├── 行棋规则(&R)       → 弹出窗口显示 rules.md 内容（或简化版）
└── 关于(&A)           → 显示程序版本、版权信息
```

### 2.9 窗口规格

| 项目                 | 规格                                                    |
| -------------------- | ------------------------------------------------------- |
| **窗口类型**   | 标准Windows窗口                                         |
| **尺寸**       | 固定大小（根据棋盘渲染尺寸确定，如800×600或1024×768） |
| **最大化按钮** | 禁用（不可最大化）                                      |
| **最小化按钮** | 禁用（不可最小化）                                      |
| **关闭按钮**   | 可用，点击后若棋局进行中则提示确认                      |
| **标题栏**     | 显示"六子冲"或"六子冲 - 对局中"                         |

## 3. 技术规格

### 3.1 推荐技术栈

| 组件     | 推荐方案                   | 备选方案              |
| -------- | -------------------------- | --------------------- |
| GUI框架  | egui + eframe              | tauri + web前端, iced |
| 2D渲染   | 内置于egui                 | wgpu, piston          |
| 音频     | rodio                      | cpal                  |
| 资源管理 | 内嵌资源（include_bytes!） | 外部文件              |
| 序列化   | serde + serde_json         | 自定义二进制格式      |

### 3.2 核心模块设计

```
src/
├── main.rs              # 程序入口
├── lib.rs               # 库导出
├── game/
│   ├── mod.rs           # 游戏状态机
│   ├── board.rs         # 棋盘与坐标
│   ├── piece.rs         # 棋子定义
│   ├── rules.rs         # 行棋规则验证
│   ├── move.rs          # 移动记录与历史
│   └── ai.rs            # AI算法实现
├── ui/
│   ├── mod.rs           # UI主模块
│   ├── app.rs           # 主应用状态
│   ├── board_view.rs    # 棋盘渲染
│   ├── piece_view.rs    # 棋子渲染与动画
│   ├── animations.rs    # 动画系统
│   └── dialogs.rs       # 对话框（新局、胜负等）
├── assets/
│   ├── images/          # 棋子、棋盘图片
│   └── sounds/          # 音效文件
└── utils/
    └── mod.rs           # 工具函数
```

### 3.3 数据结构要点

```rust
// 游戏状态
enum GameState {
    Menu,           // 主菜单/欢迎界面
    SelectingSide,  // 选择先行/后行
    PlayerTurn,     // 玩家回合（可悔棋状态）
    AiThinking,     // AI思考中
    AiMoving,       // AI行棋动画中
    GameOver(Result), // 游戏结束
}

// 棋子
struct Piece {
    id: u8,
    side: Side,     // Black / White
    position: Coord, // (x, y)
    state: PieceState,
}

enum PieceState {
    Idle,
    Dragging { mouse_pos: (f32, f32) },
    Animating { target: Coord, start_time: Instant },
    BeingCaptured { stage: CaptureStage },
}

// 移动历史（用于悔棋）
struct MoveRecord {
    piece_id: u8,
    from: Coord,
    to: Coord,
    captured: Vec<u8>, // 被吃掉的棋子ID
}
```

### 3.4 坐标与渲染

| 项目                 | 说明                                                       |
| -------------------- | ---------------------------------------------------------- |
| **棋盘坐标系** | 采用 `rules.md` 定义的坐标系：(0,0) 左下角，(3,3) 右上角 |
| **渲染坐标**   | 屏幕像素坐标，Y轴向下（与多数GUI框架一致）                 |
| **坐标转换**   | 提供 `board_to_screen()` 和 `screen_to_board()` 函数   |
| **容错范围**   | 落点判断允许棋子半径的30%-50%作为容错范围                  |

## 4. 存档格式规格

存档文件采用JSON格式，扩展名 `.liuzichong` 或 `.json`：

```json
{
  "version": "1.0",
  "save_time": "2026-02-07T15:30:00+08:00",
  "game": {
    "player_side": "Black",
    "current_turn": "White",
    "state": "PlayerTurn",
    "pieces": [
      {"id": 1, "side": "Black", "x": 0, "y": 0, "active": true},
      {"id": 7, "side": "White", "x": 0, "y": 3, "active": false}
    ],
    "move_history": [
      {"piece_id": 1, "from": [1, 0], "to": [0, 0], "captured": []}
    ]
  },
  "settings": {
    "ai_level": 3,
    "sound_enabled": true
  }
}
```

## 5. 未来扩展（非第一期）

- [ ] 跨平台支持（Linux、macOS）
- [ ] 双人对弈模式（局域网或本地热座）
- [ ] 历史棋局回放
- [ ] AI难度自适应
- [ ] 主题换肤（棋盘、棋子样式）
- [ ] 操作统计与成就系统

## 6. 参考文档

- `rules.md` - 游戏规则详细说明
